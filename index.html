<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Segment Test Page</title>
   <script>
  !function(){var i="analytics",analytics=window[i]=window[i]||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","screen","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware","register"];analytics.factory=function(e){return function(){if(window[i].initialized)return window[i][e].apply(window[i],arguments);var n=Array.prototype.slice.call(arguments);if(["track","screen","alias","group","page","identify"].indexOf(e)>-1){var c=document.querySelector("link[rel='canonical']");n.push({__t:"bpc",c:c&&c.getAttribute("href")||void 0,p:location.pathname,u:location.href,s:location.search,t:document.title,r:document.referrer})}n.unshift(e);analytics.push(n);return analytics}};for(var n=0;n<analytics.methods.length;n++){var key=analytics.methods[n];analytics[key]=analytics.factory(key)}analytics.load=function(key,n){var t=document.createElement("script");t.type="text/javascript";t.async=!0;t.setAttribute("data-global-segment-analytics-key",i);t.src="https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js";var r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(t,r);analytics._loadOptions=n};analytics._writeKey="WwGMq86D9HOfcZj4lsi3vKz1JNCBCEuQ";;analytics.SNIPPET_VERSION="4.12.0";
  
  // ============================================
  // SOURCE MIDDLEWARE: Filter 404 Pages
  // ============================================
  analytics.addSourceMiddleware(({ payload, next }) => {
    const title = payload?.obj?.properties?.title;
    
    // Drop 404 error page events
    if (title === 'Error 404 | Page not found' || title?.includes('404')) {
      console.log('[Segment Middleware] üö´ Dropping 404 event:', title);
      return null; // Event dropped - not sent to Segment
    }
    
    // Drop test user events
    const email = payload?.obj?.traits?.email || payload?.obj?.properties?.email;
    if (email?.endsWith('@test.com')) {
      console.log('[Segment Middleware] üö´ Dropping test user event:', email);
      return null;
    }
    
    // Add custom enrichment to all events
    if (payload.obj.properties) {
      payload.obj.properties.environment = 'production';
      payload.obj.properties.pageLoadTime = Date.now();
    }
    
    console.log('[Segment Middleware] ‚úÖ Event passed through:', payload.obj.type);
    next(payload); // Pass event through
  });

  analytics.load("WwGMq86D9HOfcZj4lsi3vKz1JNCBCEuQ");
  analytics.page();
  }}();
</script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .product {
      border: 1px solid #ddd;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .log {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      max-height: 300px;
      overflow-y: auto;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #00ff00;
      padding-left: 10px;
    }
    .middleware-info {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .middleware-info h3 {
      margin-top: 0;
      color: #856404;
    }
    .button-danger {
      background: #dc3545;
    }
    .button-danger:hover {
      background: #c82333;
    }
  </style>
</head>
<body>
  <h1>üõí Segment E-commerce Demo with Middleware</h1>

  <!-- Middleware Info Banner -->
  <div class="middleware-info">
    <h3>üîß Active Middleware</h3>
    <p><strong>Source Middleware:</strong></p>
    <ul>
      <li>üö´ Filters out 404 error pages</li>
      <li>üö´ Filters out test users (@test.com emails)</li>
      <li>‚ú® Enriches all events with environment & timestamp</li>
    </ul>
    <p><em>Check browser console (F12) to see middleware in action!</em></p>
  </div>

  <!-- 1. Identify User -->
  <div class="section">
    <h2>1. Identify User</h2>
    <p>Method: <code>analytics.identify()</code></p>
    <form id="signup-form">
      <input type="text" id="name" placeholder="Your Name" required>
      <input type="email" id="email" placeholder="Your Email" required>
      <button type="submit">Sign Up</button>
    </form>
    <p><small>üí° Try using an email ending in @test.com to see middleware filter it out!</small></p>
  </div>

  <!-- 2. Track Product View -->
  <div class="section">
    <h2>2. View Product</h2>
    <p>Method: <code>analytics.track('Product Viewed')</code></p>
    <div class="product">
      <h3>Wireless Headphones - $99.99</h3>
      <button onclick="viewProduct()">View Product</button>
    </div>
  </div>

  <!-- 3. Add to Cart -->
  <div class="section">
    <h2>3. Add to Cart</h2>
    <p>Method: <code>analytics.track('Product Added')</code></p>
    <button onclick="addToCart()">Add Headphones to Cart</button>
  </div>

  <!-- 4. Checkout -->
  <div class="section">
    <h2>4. Complete Order</h2>
    <p>Method: <code>analytics.track('Order Completed')</code></p>
    <button onclick="checkout()">Complete Checkout</button>
  </div>

  <!-- 5. Custom Event -->
  <div class="section">
    <h2>5. Custom Event</h2>
    <p>Method: <code>analytics.track('Custom Event')</code></p>
    <button onclick="customEvent()">Subscribe to Newsletter</button>
  </div>

   <!-- 6. Group User -->
  <div class="section">
    <h2>6. Group User</h2>
    <p>Method: <code>analytics.group()</code></p>
    <button onclick="groupUser()">Join UNIVAC Working Group</button>
  </div>

  <!-- 7. Test Middleware -->
  <div class="section">
    <h2>7. Test Middleware Filtering</h2>
    <p>Click these buttons to see middleware in action:</p>
    <button onclick="simulate404()">Simulate 404 Page (Will be filtered)</button>
    <button onclick="simulateTestUser()" class="button-danger">Sign Up as Test User (Will be filtered)</button>
  </div>

  <!-- Event Log -->
  <div class="section">
    <h2>üìä Event Log</h2>
    <p>Check browser console (F12) for detailed middleware output</p>
    <div class="log" id="log"></div>
  </div>

  <script>
    // Helper to log events
    function log(message, data) {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<strong>${message}</strong><br>${JSON.stringify(data, null, 2)}`;
      logDiv.insertBefore(entry, logDiv.firstChild);
      console.log('Segment:', message, data);
    }

    // 1. Identify User
    // 1. Identify User
document.getElementById('signup-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  const name = document.getElementById('name').value;
  const email = document.getElementById('email').value;

  try {
    // Call your backend to get the JWT token
    const response = await fetch('https://segment-test-backend.onrender.com/api/generate-intercom-jwt', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        userId: name,
        email: email,
        //name: name
      })
    });

    if (!response.ok) {
      throw new Error('Failed to generate JWT token');
    }

    const data = await response.json();
console.log('JWT Token:', data.jwtToken);
console.log('User ID:', data.userId);
console.log('Email:', data.email);
    const jwtToken = data.jwt;

    // Now identify with the JWT token
    analytics.identify(email, {
      name: name,
      email: email,
      user_id: email
    }, {
      integrations: {
        Intercom: {
          user_hash: jwtToken  // Intercom uses 'user_hash' for JWT tokens
        }
      }
    });

    log('IDENTIFY', { name, email, jwt: 'token_generated' });
    
    if (email.endsWith('@test.com')) {
      alert('‚ö†Ô∏è Test user detected! Middleware will filter this out.');
    } else {
      alert('‚úÖ User identified with Intercom JWT!');
    }
  } catch (error) {
    console.error('Error identifying user:', error);
    alert('‚ùå Error: ' + error.message);
  }
});
    // 2. View Product
    function viewProduct() {
      analytics.track('Product Viewed', {
        product_id: 'headphones_001',
        name: 'Wireless Headphones',
        price: 99.99,
        category: 'Audio'
      });

      log('TRACK: Product Viewed', {
        product_id: 'headphones_001',
        name: 'Wireless Headphones',
        price: 99.99
      });
    }

    // 3. Add to Cart
    function addToCart() {
      analytics.track('Product Added', {
        product_id: 'headphones_001',
        name: 'Wireless Headphones',
        price: 99.99,
        quantity: 1
      });

      log('TRACK: Product Added', {
        product_id: 'headphones_001',
        quantity: 1
      });
      alert('Added to cart!');
    }

    // 4. Checkout
    function checkout() {
      analytics.track('Order Completed', {
        order_id: 'order_' + Date.now(),
        total: 99.99,
        products: [{
          product_id: 'headphones_001',
          name: 'Wireless Headphones',
          price: 99.99,
          quantity: 1
        }]
      });

      log('TRACK: Order Completed', {
        order_id: 'order_' + Date.now(),
        total: 99.99
      });
      alert('Order completed!');
    }

    // 5. Custom Event
    function customEvent() {
      analytics.track('Newsletter Subscribed', {
        source: 'website',
        timestamp: new Date().toISOString()
      });

      log('TRACK: Newsletter Subscribed', {
        source: 'website'
      });
      alert('Subscribed to newsletter!');
    }

    // 6. Group User
    function groupUser() {
      analytics.group('UNIVAC Working Group', {
        principles: ['Eckert', 'Mauchly'],
        site: 'Eckert‚ÄìMauchly Computer Corporation',
        statedGoals: 'Develop the first commercial computer',
        industry: 'Technology',
        website: 'https://eckert-mauchly.com', 
        plan: 'Enterprise',                                 // Company Plan
        monthly_spend: 12000,  
        createdAt: '2025-11-04T17:38:41.990Z',
        description: 'This is the company that aims to do much higher than expected',
        name: 'Great company'
        
      });

      log('GROUP: UNIVAC Working Group', {
        principles: ['Eckert', 'Mauchly'],
        site: 'Eckert‚ÄìMauchly Computer Corporation',
        statedGoals: 'Develop the first commercial computer',
        industry: 'Technology',
        website: 'https://eckert-mauchly.com', 
        plan: 'Enterprise',                                 // Company Plan
        monthly_spend: 12000,
        createdAt: '2025-11-04T17:38:41.990Z',
        description: 'This is the company that aims to do much higher than expected',
        name: 'Great company'
      
      });

      alert('User grouped under UNIVAC Working Group!');
    }

    // 7. Test Middleware Functions
    function simulate404() {
      // Simulate a page call with 404 title
      analytics.page('Error Page', {
        title: 'Error 404 | Page not found',
        path: '/not-found',
        url: window.location.href + '/not-found'
      });

      log('PAGE: 404 Error (FILTERED BY MIDDLEWARE)', {
        title: 'Error 404 | Page not found'
      });

      alert('üö´ 404 page event sent - Check console to see middleware filtering it!');
    }

    function simulateTestUser() {
      analytics.identify('testuser@test.com', {
        name: 'Test User',
        email: 'testuser@test.com'
      });

      log('IDENTIFY: Test User (FILTERED BY MIDDLEWARE)', {
        email: 'testuser@test.com'
      });

      alert('üö´ Test user event sent - Check console to see middleware filtering it!');
    }

    // Log page load
    log('PAGE LOADED', { url: window.location.href });
    console.log('%cüîß Middleware Active!', 'color: #ffc107; font-size: 16px; font-weight: bold;');
    console.log('Source Middleware: Filtering 404s and test users, enriching events');
  </script>
</body>
</html>
